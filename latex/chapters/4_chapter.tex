\chapter{Verwendetes Betriebssystem}
In diesem Kapitel wird die Installation des Betriebssystem Ubuntu Mate, sowie die Einrichtung des Frameworks ROS näher erläutert. Außerdem werden alle nötigen Konfigurationen gezeigt, um die Software kompilieren und ausführen zu können. 


\section{Installation von Ubuntu Mate auf Raspberry Pi 3b+}
Aufgrund einer sehr großen Ubuntu Community und die gute Anbindung an das Framework ROS, wurde sich für das Betriebssystem Ubuntu Mate entschieden. Da keine durchgängige Echtzeitanbindung gefordert ist, werden hier der SLAM sowie die Wegefindung berechnet und ausgeführt. Die Sensoren der Motorsteuerung agieren dagegen auf einem STM Board um schneller auf Änderungen reagieren zu können. 
Da zum aktuellen Zeitpunkt (25.10.2018) kein angepasstes Betriebssystem für den Raspberry Pi 3b+ zur Verfügung steht, mussten kleinere Konfigurationen stattfinden um das vorhandene Raspberry Pi 3 Image auf einem Rasperry Pi 3b+ zum laufen zu bekommen. 
Problem ohne diese Einstellungen: Der Raspberry Pi 3b+ startet nicht und es wird nur ein Regenbogen Bildschirm angezeigt!

Nachfolgend werden alle Konfigurationen genauer erläutert. 

1. Download eines Images für Raspberry  Pi 2/3 auf folgender Seite:

2. Flashen des Images auf einer SD-Karte mit Win32DiskImages oder (linux):

3. Diese SD-Karte in einen \textbf{Raspberry Pi 2} oder \textbf{Raspberry Pi 3} einstecken und starten. 

4. Danach ein Terminal öffnen und folgenden Befehl für ein Kernel Update eingeben:\\

\begin{lstlisting}
$ sudo CURL_CA_BUNDLE=/etc/ssl/certs/ca-certificates.crt rpi-update
\end{lstlisting}

oder alternativ:\\

\begin{lstlisting}
$ sudo BRANCH=stable rpi-update
\end{lstlisting}

5. Raspberry Pi 2/3 herunterfahren und diese SD-Karte in den Raspberry Pi 3b+ einstecken. Der Pi sollte dann wie gewünscht booten. 

6. Zu diesem Zeitpunkt ist aber noch keine Wlan-Verbindung verfügbar. Installiere das neueste Raspbian Image von hier auf eine weitere SD-Karte. 

7. Starte einen Raspberry Pi mit dem Raspbian Betriebssystem und kopiere folgenden Ordner auf einen USB-Stick.\\

\begin{lstlisting}
$ sudo cp -r /lib/firmware/brcm /path_to_usb
\end{lstlisting}

8. Starte den Raspberry Pi 3b+ mit der SD-Karte auf der Ubuntu Mate installiert ist. 

9. Ersetze den aktuellen /lib/firmware/brcm Ordner durch den am USB-Stick\\

\begin{lstlisting}
$ sudo cp -r /path_to_usb/lib/firmware/brcm /lib/firmware/brcm
\end{lstlisting}

10. Führe einen Neustart durch und eine Wlan-Verbindung sollte verfügbar sein.

11. Aktiviere ssh durch folgenden Befehl\\

\begin{lstlisting}
$ sudo systemctl enable ssh
\end{lstlisting}


\section{Installation des Frameworks Robot Operating System (ROS)}

Nachfolgend wird Installation des Frameworks ROS durchgeführt. Dazu auf dem Betriebssystem Ubuntu Mate ein Terminal öffnen und folgende Befehle eingeben:

1. Einrichten der sources.list\\

\begin{lstlisting}
$ sudo sh -c 'echo "deb http://packages.ros.org/ros/ubuntu $(lsb_release -sc) main" > /etc/apt/sources.list.d/ros-latest.list'
\end{lstlisting}

2. Einrichten der keys\\

\begin{lstlisting}
$ wget http://packages.ros.org/ros.key -O - | sudo apt-key add -
\end{lstlisting}

3. Update der Packages\\

\begin{lstlisting}
$ sudo apt-get update
\end{lstlisting}

4. Install ros-kinetic-desktop-full\\

\begin{lstlisting}
$ sudo apt-get install ros-kinetic-desktop-full
\end{lstlisting}

5. Initialisierung und Update der Rosdep\\

\begin{lstlisting}
$ sudo rosdep init
\end{lstlisting}

\begin{lstlisting}
$ rosdep update
\end{lstlisting}

6. Einrichten der ROS Umgebungsvariablen\\

\begin{lstlisting}
$ echo "source /opt/ros/kinetic/setup.bash" >> ~/.bashrc
\end{lstlisting}

Neues Terminal öffnen oder nachfolgenden Befehl eingeben:\\

\begin{lstlisting}
$ source ~/.bashrc
\end{lstlisting}

7. Erstellen eines catkin workspaces \\

\begin{lstlisting}
$ mkdir -p ~/catkin_ws/src
\end{lstlisting}

\begin{lstlisting}
$ cd ~/catkin_ws/
\end{lstlisting}

\begin{lstlisting}
$ catkin_make
\end{lstlisting}

\begin{lstlisting}
$ source ~/catkin_ws/devel/setup.bash
\end{lstlisting}

Durch nachfolgenden Befehl hat man von überall im Linux System Zugriff auf die im catkin workspace gebildeten Packages:\\ 

%\begin{lstlisting}
% echo “source ~/catkin_ws/devel/setup.bash” >> ~/.bashrc
%\end{lstlisting}

\section{Schreibzugriff auf den Hokuyo Port für den aktuellen Benutzer}
Um nicht Root Rechte besitzen zu müssen um auf den Hokuyo Port zugreifen zu können, wurde der akuelle Benutzer in die Dialout Gruppe mit folgendem Befehl hinzugefügt:\\

\begin{lstlisting}
$ sudo adduser "user_name" dialout
\end{lstlisting}

\section{Roscore Master und Launch file als Systemd Service}
Da sich die SLAM Map sofort nach dem Start aufbauen soll, wurde sich für systemd services entschieden. Diese werden beim hochfahren des Raspberry Pi 3b+ ausgeführt, außerdem kann der jeweilige Service auch nachträglich per Kommando gestartet und gestoppt werden. 
Da der roscore Master benötigt wird, um innerhalb des ROS Frameworks zu kommunizieren, wurde dieser als einzelner Service entworfen. Hierfür muss unter /etc/systemd/system eine Datei roscore.service mit folgendem Inhalt erstellt werden. 


\begin{lstlisting}
[Unit]
Description=starts roscore master as a systemd service

[Service]
Type=simple
ExecStart=/bin/bash -c "source /opt/ros/kinetic/setup.bash; /usr/bin/python /opt/ros/kinetic/bin/roscore"

[Install]
WantedBy=multi-user.target
\end{lstlisting}

Um das ROS launch File hokuyo\_hector\_slam.launch als Service auszuführen wurde eine Datei hector.service in /etc/systemd/service mit folgendem Inhalt erstellt. 

\begin{lstlisting}
[Unit]
Description=starts hokuyo_hector_slam launch file as a systemd service

[Service]
Type=simple
ExecStart=/bin/bash -c "source /opt/ros/kinetic/setup.bash; /usr/bin/python /opt/ros/kinetic/bin/roscore"
ExecStop=
Restart=on-failure

[Install]
WantedBy=multi-user.target
\end{lstlisting}

